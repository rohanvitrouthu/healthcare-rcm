# Configuring the Azure provider
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~>3.85.0"
    }
  }
  required_version = ">=1.5.0"
}

provider "azurerm" {
  features {
    key_vault {
      purge_soft_delete_on_destroy    = true
      recover_soft_deleted_key_vaults = true
    }
  }
}

# Variables
variable "project_name" {
  description = "Project name prefix"
  default     = "healthcarercm"
}

variable "environment" {
  description = "Environment name"
  default     = "dev"
}

variable "location" {
  description = "Azure region"
  default     = "eastus"
}

# Resource Group
resource "azurerm_resource_group" "main" {
  name     = "rg-${var.project_name}-${var.environment}"
  location = var.location

  tags = {
    Environment = var.environment
    Project     = var.project_name
    ManagedBy   = "Terraform"
  }
}

module "storage" {
  source = "../../modules/storage"

  # Passing variables in ../../modules/storage/variables.tf to this module
  project_name        = var.project_name
  environment         = var.environment
  location            = var.location
  resource_group_name = azurerm_resource_group.main.name

  # Optional overrides
  account_replication_type = "LRS"
  containers               = ["landing", "bronze", "silver", "gold"]

  tags = {
    CostCenter = "DataEngineering"
    Owner      = "DataTeam"
  }
}

# Key-Vault Module

module "key_vault" {
  source = "../../modules/key-vault"

  project_name        = var.project_name
  environment         = var.environment
  location            = var.location
  resource_group_name = azurerm_resource_group.main.name

  # Enterprise Configuration
  sku_name                    = "standard"
  soft_delete_retention_days  = 7
  purge_protection_enabled    = false # Please set to true in production.
  enabled_for_disk_encryption = true

  # Network access (Adjust the below for production)
  public_network_access_enabled = true

  # Secrets to store
  secrets = {
    "storage-account-name"      = module.storage.storage_account_name
    "storage-account-key"       = module.storage.primary_access_key
    "storage-connection-string" = module.storage.primary_connection_string
    "storage-dfs-endpoint"      = module.storage.primary_dfs_endpoint
  }

  tags = {
    CostCenter = "DataEngineering"
    Compliance = "HIPAA"
  }

  depends_on = [module.storage]
}

# Outputs
output "storage_account_name" {
  value = module.storage.storage_account_name
}

output "storage_account_id" {
  value = module.storage.storage_account_id
}

output "resource_group_name" {
  description = "Name of the resource group"
  value       = azurerm_resource_group.main.name
}

output "primary_dfs_endpoint" {
  description = "Data Lake Gen2 endpoint"
  value       = module.storage.primary_dfs_endpoint
}

output "key_vault_name" {
  description = "Name of the key vault"
  value       = module.key_vault.key_vault_name
}

output "key_vault_uri" {
  description = "URI of the Key Vault"
  value       = module.key_vault.key_vault_uri
}

output "key_vault_rbac_info" {
  description = "Information about RBAC configuration"
  value = {
    rbac_enabled    = true
    administrator   = "Current user/service principal"
    secrets_officer = "Current user/service principal"
  }
}
