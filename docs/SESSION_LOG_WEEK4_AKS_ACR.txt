# Session Log: AKS & ACR Infrastructure Setup (Week 4)
Date: December 18, 2025

## 1. Overview
This session focused on provisioning the Azure Kubernetes Service (AKS) cluster and Azure Container Registry (ACR) using Terraform, as part of the "Healthcare RCM Data Engineering Project". The goal was to set up a cost-effective (near-zero cost) environment for deploying containerized data workloads.

## 2. Infrastructure Changes

### 2.1 Azure Kubernetes Service (AKS)
- **Module Used:** `terraform/modules/aks`
- **Resource Created:** `aks-healthcarercm-dev`
- **Location:** East US
- **Configuration:**
  - **Kubernetes Version:** 1.32.9 (Selected as the latest non-LTS version supported in the region).
  - **Node Pool:** 1 node (min) to 3 nodes (max) auto-scaling.
  - **VM Size:** `Standard_D2s_v3` (Selected for compatibility and stability after `Standard_B2s` was found unavailable).
  - **Tier:** Free Tier (No SLA for API server).
  - **Identity:** System Assigned Managed Identity.
  - **Monitoring:** Azure Monitor for Containers enabled with a Log Analytics Workspace.

### 2.2 Azure Container Registry (ACR)
- **Module Created:** `terraform/modules/acr`
- **Resource Created:** `acrhealthcarercmdev`
- **SKU:** Basic (Cost-effective choice).
- **Integration:** Assigned `AcrPull` role to the AKS Kubelet Identity to allow seamless image pulling.

## 3. Issues Encountered & Resolutions

### Issue 1: Deprecated Azure AD Integration Argument
- **Error:**
  ```
  Error: Missing required argument ... "azure_active_directory_role_based_access_control.0.managed" ... must be specified
  ```
- **Context:** The Terraform provider version `3.117.1` still requires the `managed = true` argument inside the `azure_active_directory_role_based_access_control` block, even though it is marked as deprecated in documentation and will be removed in v4.0.
- **Resolution:** Re-added `managed = true` to the `terraform/modules/aks/main.tf` configuration to satisfy the current provider's validation requirements.

### Issue 2: Invalid VM Size for Location
- **Error:**
  ```
  The VM size of Standard_B2s is not allowed in your subscription in location 'eastus'.
  ```
- **Context:** The initially selected `Standard_B2s` (Burstable) VM size was not available for subscription/region combination.
- **Resolution:**
  - Checked available VM sizes using `az aks get-versions`.
  - Updated `terraform/environments/dev/main.tf` to use `Standard_D2s_v3`, a widely available and standard general-purpose SKU suitable for system nodes.

### Issue 3: Kubernetes Version Availability
- **Context:** The initial configuration used version `1.28.3`, which was no longer supported/available for new non-LTS clusters in `eastus`.
- **Resolution:**
  - Queried available versions via CLI: `az aks get-versions --location eastus --output table`.
  - Updated configuration to use `1.32.9`.

### Issue 4: Local Kubectl Authentication
- **Error:** `kubelogin: command not found` after running `az aks get-credentials`.
- **Context:** The cluster uses Azure AD authentication, which requires the `kubelogin` binary.
- **Resolution:**
  - Attempted `az aks install-cli` (failed due to permission issues on system folders).
  - **Workaround:** Verified cluster access is possible via Azure CLI context or by using `az aks get-credentials` with `--admin` (though standard user access was configured). *Note: `kubelogin` installation is still recommended for the user's local machine for non-admin access.*

## 4. Final State
- **AKS Cluster:** Provisioned and active (`aks-healthcarercm-dev`).
- **ACR:** Provisioned and ready (`acrhealthcarercmdev.azurecr.io`).
- **Connectivity:** `kubectl` is configured to connect to the cluster.
- **Permissions:** AKS has permission to pull images from ACR.

## 5. Next Steps
1.  **Build Workloads:** Build Docker images for the NPI, ICD, and CPT extractors.
2.  **Push to ACR:** Push these images to `acrhealthcarercmdev.azurecr.io`.
3.  **Deploy to AKS:** Create Kubernetes manifests (Deployment, Service) to run these containers on the new cluster.
